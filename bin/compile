#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast
set -e

BASE_DIR=$(cd . && pwd)
BUILD_DIR=$(cd "$1" && pwd)
CACHE_DIR=$2

echo "-----> BUILD_DIR=${BUILD_DIR}"
echo "-----> CACHE_DIR=${CACHE_DIR}"

SQUEAK_VERSION="4.4-12327"
BUILDPACK_SQUEAK_BASE_URL="http://ftp.squeak.org/"
[ -z ${SQUEAK_VERSION} ] && echo " !     Please set SQUEAK_VERSIONx" && exit 1
[ -z ${BUILDPACK_SQUEAK_BASE_URL} ] && echo " !     Please set BUILDPACK_SQUEAK_BASE_URL" && exit 1;

echo "-----> Building application using Squeak ${SQUEAK_VERSION}"
echo "-----> Fetching artifacts from ${BUILDPACK_SQUEAK_BASE_URL}"

MAJOR_VERSION="$(echo ${SQUEAK_VERSION} | cut -d"-" -f1)"
# This is utterly retarded.
#SOURCES_VERSION="$(echo ${MAJOR_VERSION} | cut -d"." -f1)$(echo ${MAJOR_VERSION} | cut -d"." -f2)"
SOURCES_VERSION=41
IMAGE_URL=${BUILDPACK_SQUEAK_BASE_URL}/${MAJOR_VERSION}/Squeak${SQUEAK_VERSION}.tgz
SOURCES_URL=${BUILDPACK_SQUEAK_BASE_URL}/${MAJOR_VERSION}/SqueakV${SOURCES_VERSION}.sources.gz
VM_URL=${BUILDPACK_SQUEAK_BASE_URL}/${MAJOR_VERSION}/unix-linux/coglinux.tgz

mkdir -p ${CACHE_DIR}

# Set up the VM
if test -d ${CACHE_DIR}/cog.r2640/
then
    echo "-----> Using Cog r2640"
else
    echo "-----> Downloading Cog r2640"
    rm -rf ${CACHE_DIR}/cog*
    mkdir -p ${CACHE_DIR}/cog.r2640/
    cd ${CACHE_DIR}/cog.r2640/
    curl --silent --show-error --max-time 60 -L -O ${VM_URL}
    tar zxf coglinux.tgz
    rm coglinux.tgz
fi

# Set up the base image
if test -d ${CACHE_DIR}/${SQUEAK_VERSION}/
then
    echo "-----> Using Squeak ${SQUEAK_VERSION}"
else
    echo "-----> Downloading Squeak ${SQUEAK_VERSION}"
    rm -rf ${CACHE_DIR}/Squeak-${SQUEAK_VERSION}*
    mkdir -p ${CACHE_DIR}/Squeak-${SQUEAK_VERSION}
    cd ${CACHE_DIR}/Squeak-${SQUEAK_VERSION}
    curl --silent --show-error --max-time 60 -L -O ${IMAGE_URL}
    curl --silent --show-error --max-time 60 -L -O ${SOURCES_URL}
    tar zxvf Squeak${SQUEAK_VERSION}.tgz
    gunzip SqueakV${SOURCES_VERSION}.sources.gz
    rm Squeak${SQUEAK_VERSION}.tgz
fi

# Install the application, unless (for testing purposes) we
# deliberately skip this step.
if test -z "${SKIP_INSTALLATION}"
then
    echo "-----> Installing application"
    REPO_TYPE="$(${BASE_DIR}/bin/detect ${BUILD_DIR})"
    INSTALLER="We couldn't identify the repository."
    case ${REPO_TYPE} in
	"Squeak (Filetree)")
	    INSTALLER="filetree-installer.st"
	    # Find the Configuration and run it?
	    ;;
	*) echo " !     Unknown repository 'type ${REPO_TYPE}'" && exit 1;;
    esac
    export BUILD_DIR
    ${CACHE_DIR}/cog.r2640/coglinux/bin/squeak -vm-display-null -vm-sound-null ${CACHE_DIR}/Squeak-${SQUEAK_VERSION}/Squeak${SQUEAK_VERSION}.image ${BASE_DIR}/installers/filetree-installer.st
else
    echo "-----> Skipping installation"
fi